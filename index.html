<script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/afVbR2wifH/";
    let model, webcam, labelContainer, maxPredictions;
    let lastFrameTime = performance.now();
    let frameCount = 0;
    const cameraSelect = document.getElementById("camera-facing");

    window.onload = () => {
        init();
    };

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        await getDevices().then(gotDevices).then(setupWebcam);
        window.requestAnimationFrame(loop);

        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }

        // 1 saniye sonra arka kameraya geç
        setTimeout(() => switchToBackCamera(), 1000);
    }

    async function getDevices() {
        return navigator.mediaDevices.enumerateDevices();
    }

    function gotDevices(deviceInfos) {
        cameraSelect.innerHTML = "";
        window.deviceInfos = deviceInfos;
        console.log("Kullanılabilir cihazlar:", deviceInfos);
        for (const deviceInfo of deviceInfos) {
            if (deviceInfo.kind === "videoinput") {
                const option = document.createElement("option");
                option.value = deviceInfo.deviceId;
                option.text = deviceInfo.label || `Camera ${cameraSelect.length + 1}`;
                cameraSelect.appendChild(option);
            }
        }
    }

    async function setupWebcam() {
        const size = parseInt(document.getElementById("camera-size").value);
        const deviceId = cameraSelect.value;

        if (webcam) {
            await webcam.stop();
        }

        webcam = new tmImage.Webcam(size, size, true);

        const constraints = {
            video: {
                deviceId: deviceId ? { exact: deviceId } : undefined,
                width: { ideal: size },
                height: { ideal: size }
            }
        };

        try {
            console.log("Kamera ayarları:", constraints);
            await webcam.setup(constraints);
            await webcam.play();
            console.log("Kamera başlatıldı:", cameraSelect.options[cameraSelect.selectedIndex].text);
        } catch (error) {
            console.error("Kamera başlatılamadı:", error);
            alert("Kamera başlatılamadı. Lütfen cihazınızı kontrol edin.");
        }
    }

    async function loop(timestamp) {
        webcam.update();
        await predict();
        
        frameCount++;
        const currentTime = performance.now();
        const deltaTime = (currentTime - lastFrameTime) / 1000;
        if (deltaTime >= 1) {
            const fps = Math.round(frameCount / deltaTime);
            document.getElementById("fps").textContent = `FPS: ${fps}`;
            frameCount = 0;
            lastFrameTime = currentTime;
        }

        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction;
        }
    }

    async function updateCamera() {
        if (webcam) {
            await setupWebcam();
            document.getElementById("webcam-container").innerHTML = "";
            document.getElementById("webcam-container").appendChild(webcam.canvas);
        }
    }

    function switchToBackCamera() {
        for (const option of cameraSelect.options) {
            if (option.text.toLowerCase().includes("back") || option.text.toLowerCase().includes("arka")) {
                cameraSelect.value = option.value;
                updateCamera();
                break;
            }
        }
    }
</script>
